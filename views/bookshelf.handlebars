<div class="bookshelf-page">
  <div class="bookshelf-header">
    <h1>Welcome to Your Bookshelf, {{username}}!</h1>
  </div>

  <!-- Book Search -->
  <section class="search-section">
  <h2>Search for Books</h2>
    <div class="search-container">
      <input 
        type="text" 
        id="searchInput" 
        placeholder="Search by title or author..." 
        class="search-input"
      >
      <button id="searchBtn" class="btn btn-primary">Search</button>
    </div>

    <!-- Search Results -->
    <div id="searchResults" class="search-results" style="display: none;">
      <h3>Search Results</h3>
      <div id="resultsList"></div>
    </div>
  </section>

  <!-- Want to Read -->
  <section class="books-section">
  <h2>ðŸ“š Want to Read</h2>
    <div class="books-grid">
      {{#if wantToReadBooks.length}}
        {{#each wantToReadBooks}}
          <div class="book-card" data-book-id="{{this.id}}">
            {{#if this.cover_id}}
              <img src="https://covers.openlibrary.org/b/id/{{this.cover_id}}-M.jpg" 
                    alt="{{this.title}} cover" 
                  class="book-cover">
            {{else}}
              <div class="book-cover-placeholder">ðŸ“–</div>
            {{/if}}
            <div class="book-info">
              <h3 class="book-title">{{this.title}}</h3>
              <p class="book-author">by {{this.author_names}}</p>
              {{#if this.first_publish_year}}
                <p class="book-detail">Published: {{this.first_publish_year}}</p>
              {{/if}}
            </div>
            <div class="book-actions">
              <button class="btn btn-small btn-primary move-book" 
                    data-book-id="{{this.id}}" 
                    data-new-status="have_read">
                Mark as Read âœ“
              </button>
              <button class="btn btn-small btn-text delete-book" 
                  data-book-id="{{this.id}}">
              Remove âœ•
              </button>
            </div>
          </div>
        {{/each}}
      {{else}}
           <p class="empty-message">You haven't added any books to your want-to-read list yet. Search for books above to get started!</p>
      {{/if}}
    </div>
  </section>

  <!-- Have Read Section -->
  <section class="books-section">
    <h2>âœ“ Have Read</h2>
    <div class="books-grid">
      {{#if readBooks.length}}
        {{#each readBooks}}
          <div class="book-card" data-book-id="{{this.id}}">
            {{#if this.cover_id}}
              <img src="https://covers.openlibrary.org/b/id/{{this.cover_id}}-M.jpg" 
                   alt="{{this.title}} cover" 
                   class="book-cover">
            {{else}}
              <div class="book-cover-placeholder">ðŸ“–</div>
            {{/if}}
            <div class="book-info">
              <h3 class="book-title">{{this.title}}</h3>
              <p class="book-author">by {{this.author_names}}</p>
              {{#if this.first_publish_year}}
                <p class="book-detail">Published: {{this.first_publish_year}}</p>
              {{/if}}
              {{#if this.date_completed}}
                <p class="book-detail">Completed: {{this.date_completed}}</p>
              {{/if}}
            </div>
            <div class="book-actions">
              <button class="btn btn-small btn-secondary move-book" 
                      data-book-id="{{this.id}}" 
                      data-new-status="want_to_read">
                Move to Want to Read
              </button>
              <button class="btn btn-small btn-text delete-book" 
                      data-book-id="{{this.id}}">
                Remove âœ•
              </button>
            </div>
          </div>
        {{/each}}
      {{else}}
        <p class="empty-message">You haven't marked any books as read yet. Move books from your want-to-read list when you finish them!</p>
      {{/if}}
    </div>
  </section>
</div>

<!-- Toast notification -->
<div id="toast" class="toast"></div>

<style>
.bookshelf-page {
  text-align: left;
}

.bookshelf-header {
  text-align: center;
  margin-bottom: calc(var(--space) * 3);
}

.search-section {
  background-color: var(--dark-grey);
  padding: calc(var(--space) * 2);
  border-radius: 8px;
  margin-bottom: calc(var(--space) * 3);
  border-left: 4px solid var(--primary);
}

.search-section h2 {
  margin-top: 0;
  color: var(--primary);
}

.search-container {
  display: flex;
  gap: var(--space);
  margin-bottom: var(--space);
}

.search-input {
  flex: 1;
  padding: calc(var(--space) * 0.75);
  font-size: var(--font-size);
  border-radius: 4px;
  border: 2px solid var(--black);
  background-color: var(--black);
  color: var(--text-color);
}

.search-input:focus {
  outline: none;
  border-color: var(--primary);
}

.search-results {
  margin-top: calc(var(--space) * 2);
}

.search-results h3 {
  color: var(--primary);
  margin-bottom: var(--space);
}

#resultsList {
  display: flex;
  flex-direction: column;
  gap: var(--space);
}

.search-result-card {
  background: var(--black);
  padding: var(--space);
  border-radius: 4px;
  display: flex;
  gap: var(--space);
  align-items: start;
}

.search-result-cover {
  width: 60px;
  height: 90px;
  object-fit: cover;
  border-radius: 4px;
  flex-shrink: 0;
}

.search-result-cover-placeholder {
  width: 60px;
  height: 90px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--dark-grey);
  border-radius: 4px;
  font-size: 2em;
  flex-shrink: 0;
}

.search-result-info {
  flex: 1;
  min-width: 0;
}

.search-result-info h4 {
  margin: 0 0 calc(var(--space) * 0.5) 0;
  color: var(--text-color);
}

.search-result-info p {
  margin: calc(var(--space) * 0.25) 0;
  color: var(--light-grey);
  font-size: 0.9em;
}

.search-result-actions {
  display: flex;
  flex-direction: column;
  gap: calc(var(--space) * 0.5);
  flex-shrink: 0;
}

.books-section {
  margin-bottom: calc(var(--space) * 4);
}

.books-section h2 {
  color: var(--primary);
  padding-bottom: var(--space);
  border-bottom: 2px solid var(--dark-grey);
  margin-bottom: calc(var(--space) * 2);
}

.books-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: calc(var(--space) * 1.5);
}

.book-card {
  background: var(--dark-grey);
  padding: var(--space);
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  transition: transform 0.2s, box-shadow 0.2s;
  border-left: 4px solid var(--primary);
}

.book-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
}

.book-cover {
  width: 100%;
  height: 300px;
  object-fit: cover;
  border-radius: 4px;
  margin-bottom: var(--space);
}

.book-cover-placeholder {
  width: 100%;
  height: 300px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--black);
  border-radius: 4px;
  margin-bottom: var(--space);
  font-size: 4em;
}

.book-info {
  flex: 1;
  margin-bottom: var(--space);
}

.book-title {
  color: var(--text-color);
  font-size: 1.2em;
  margin: 0 0 calc(var(--space) * 0.5) 0;
}

.book-author {
  color: var(--light-grey);
  font-style: italic;
  margin: calc(var(--space) * 0.5) 0;
}

.book-detail {
  color: var(--light-grey);
  font-size: 0.85em;
  margin: calc(var(--space) * 0.25) 0;
}

.book-actions {
  display: flex;
  flex-direction: column;
  gap: calc(var(--space) * 0.5);
}

.btn-small {
  padding: calc(var(--space) * 0.5) var(--space);
  font-size: 0.9em;
}

.empty-message {
  color: var(--light-grey);
  font-style: italic;
  text-align: center;
  padding: calc(var(--space) * 3);
  grid-column: 1 / -1;
}

.toast {
  position: fixed;
  bottom: var(--space);
  right: var(--space);
  padding: var(--space);
  border-radius: 4px;
  font-weight: bold;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.3s;
  z-index: 1000;
  max-width: 300px;
}

.toast.show {
  opacity: 1;
  transform: translateY(0);
}

.toast.success {
  background-color: var(--primary);
  color: var(--black);
}

.toast.error {
  background-color: var(--secondary);
  color: var(--text-color);
}

@media (max-width: 700px) {
  .books-grid {
    grid-template-columns: 1fr;
  }
  
  .search-container {
    flex-direction: column;
  }
  
  .search-result-card {
    flex-direction: column;
  }
  
  .search-result-actions {
    flex-direction: row;
    width: 100%;
  }
  
  .search-result-actions .btn {
    flex: 1;
  }
}
</style>

<script>
// Search functionality
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const searchResults = document.getElementById('searchResults');
const resultsList = document.getElementById('resultsList');

// Show toast notification
function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast ${type} show`;
  setTimeout(() => {
    toast.className = 'toast';
  }, 3000);
}

// Search for books
async function searchBooks() {
  const query = searchInput.value.trim();
  if (!query) {
    showToast('Please enter a search term', 'error');
    return;
  }

  try {
    searchBtn.disabled = true;
    searchBtn.textContent = 'Searching...';

    const response = await fetch(`/api/search-books?q=${encodeURIComponent(query)}`);
    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Search failed');
    }

    displaySearchResults(data.books);
  } catch (error) {
    console.error('Search error:', error);
    showToast(error.message || 'Error searching for books', 'error');
  } finally {
    searchBtn.disabled = false;
    searchBtn.textContent = 'Search';
  }
}

// Display search results
function displaySearchResults(books) {
  if (books.length === 0) {
    resultsList.innerHTML = '<p class="empty-message">No books found. Try a different search term.</p>';
    searchResults.style.display = 'block';
    return;
  }

  resultsList.innerHTML = books.map(book => `
    <div class="search-result-card">
      ${book.cover_id 
        ? `<img src="https://covers.openlibrary.org/b/id/${book.cover_id}-S.jpg" 
                alt="${book.title} cover" 
                class="search-result-cover">`
        : '<div class="search-result-cover-placeholder">ðŸ“–</div>'
      }
      <div class="search-result-info">
        <h4>${book.title}</h4>
        <p>by ${book.author_names}</p>
        ${book.first_publish_year ? `<p>Published: ${book.first_publish_year}</p>` : ''}
        ${book.edition ? `<p>${book.edition}</p>` : ''}
        ${book.isbn ? `<p>ISBN: ${book.isbn}</p>` : ''}
      </div>
      <div class="search-result-actions">
        <button class="btn btn-small btn-primary add-book" 
                data-ol-key="${book.ol_key}"
                data-title="${escapeHtml(book.title)}"
                data-author="${escapeHtml(book.author_names)}"
                data-year="${book.first_publish_year || ''}"
                data-cover="${book.cover_id || ''}"
                data-status="want_to_read">
          Want to Read
        </button>
        <button class="btn btn-small btn-secondary add-book" 
                data-ol-key="${book.ol_key}"
                data-title="${escapeHtml(book.title)}"
                data-author="${escapeHtml(book.author_names)}"
                data-year="${book.first_publish_year || ''}"
                data-cover="${book.cover_id || ''}"
                data-status="have_read">
          Have Read
        </button>
      </div>
    </div>
  `).join('');

  searchResults.style.display = 'block';

  //buttons
  document.querySelectorAll('.add-book').forEach(btn => {
  btn.addEventListener('click', addBook);
  });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Add book 
async function addBook(e) {
  const btn = e.target;
  const bookData = {
    ol_key: btn.dataset.olKey,
    title: btn.dataset.title,
    author_names: btn.dataset.author,
    first_publish_year: btn.dataset.year ? parseInt(btn.dataset.year) : null,
    cover_id: btn.dataset.cover || null,
    status: btn.dataset.status
  };

  try {
    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = 'Adding...';

    const response = await fetch('/api/books', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(bookData)
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Failed to add book');
    }

    showToast('Book added successfully!', 'success');
    
   
    setTimeout(() => {
      window.location.reload();
    }, 1000);
  } catch (error) {
    console.error('Add book error:', error);
    showToast(error.message || 'Error adding book', 'error');
    btn.disabled = false;
    btn.textContent = originalText;
  }
}

// Move book 
async function moveBook(e) {
  const btn = e.target;
  const bookId = btn.dataset.bookId;
  const newStatus = btn.dataset.newStatus;

  try {
    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = 'Moving...';

    const response = await fetch(`/api/books/${bookId}/move`, {
      method: 'PUT',
      
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ status: newStatus })
    });

    const data = await response.json();

    if (!response.ok) {
        throw new Error(data.error || 'Failed to move book');
    }

    showToast('Book moved successfully!', 'success');
    
    setTimeout(() => {
      window.location.reload();
    }, 1000);
  } catch (error) {
     console.error('Move book error:', error);
    showToast(error.message || 'Error moving book', 'error');
    btn.disabled = false;

    btn.textContent = originalText;
  }
}


async function deleteBook(e) {
  const btn = e.target;
  const bookId = btn.dataset.bookId;

  if (!confirm('Are you sure you want to remove this book from your collection?')) {
    return;
  }

  try {
    btn.disabled = true;
    btn.textContent = 'Removing...';

    const response = await fetch(`/api/books/${bookId}`, {
      method: 'DELETE'
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Failed to delete book');
    }

    showToast('Book removed successfully!', 'success');
    
   
    const card = btn.closest('.book-card');
    card.style.opacity = '0';
    card.style.transform = 'scale(0.8)';
    setTimeout(() => {
      card.remove();
       const grid = card.closest('.books-grid');
      if (grid.children.length === 0) {
        grid.innerHTML = '<p class="empty-message">No books in this section yet.</p>';
      }
    }, 300);
  } catch (error) {
    console.error('Delete book error:', error);
    showToast(error.message || 'Error deleting book', 'error');
    btn.disabled = false;
    btn.textContent = 'Remove âœ•';
  }
}
searchBtn.addEventListener('click', searchBooks);
searchInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    searchBooks();
  }
});
document.querySelectorAll('.move-book').forEach(btn => {
  btn.addEventListener('click', moveBook);
});

document.querySelectorAll('.delete-book').forEach(btn => {
  btn.addEventListener('click', deleteBook);
});
</script>
